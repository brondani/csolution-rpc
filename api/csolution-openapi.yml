openapi: 3.1.0
info:
  title: csolution rpc
  version: 0.0.2
  description: Specification of remote procedure call methods for CMSIS csolution integration
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
servers:
  - url: http://localhost:3000

paths:
  /rpc/GetVersion:
    post:
      summary: Get version
      description: Get version of csolution rpc server
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/GetVersionRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/GetVersionResponse'}}}
  /rpc/Shutdown:
    post:
      summary: Shutdown
      description: Shutdown csolution rpc server
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/ShutdownRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/ShutdownResponse'}}}
  /rpc/Apply:
    post:
      summary: Apply component selection changes
      description: Apply component selection changes for the given context
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/ApplyRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/ApplyResponse'}}}
  /rpc/Resolve:
    post:
      summary: Resolve trivial component dependencies
      description: Resolve trivial component dependencies for the given context
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/ResolveRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/ResolveResponse'}}}
  /rpc/LoadPacks:
    post:
      summary: Load installed and local packs
      description: Load packs indexed in the CMSIS_PACK_ROOT
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/LoadPacksRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/LoadPacksResponse'}}}
  /rpc/LoadSolution:
    post:
      summary: Load solution
      description: Load solution
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/LoadSolutionRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/LoadSolutionResponse'}}}
  /rpc/GetUsedItems:
    post:
      summary: Get used items
      description: Get used items
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/GetUsedItemsRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/GetUsedItemsResponse'}}}
  /rpc/GetPacksInfo:
    post:
      summary: Get packs information
      description: Get installed and local packs information
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/GetPacksInfoRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/GetPacksInfoResponse'}}}
  /rpc/GetComponentsTree:
    post:
      summary: Get components tree
      description: Get tree of filtered components, APIs, bundles and taxonomy information
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/GetComponentsTreeRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/GetComponentsTreeResponse'}}}
  /rpc/SelectComponent:
    post:
      summary: Select component
      description: Select component
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/SelectComponentRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/SelectComponentResponse'}}}
  /rpc/SelectVariant:
    post:
      summary: Select variant
      description: Select variant
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/SelectVariantRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/SelectVariantResponse'}}}
  /rpc/SelectBundle:
    post:
      summary: Select bundle
      description: Select bundle
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/SelectBundleRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/SelectBundleResponse'}}}
  /rpc/ValidateComponents:
    post:
      summary: Validate components list
      description: Validate components list
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/ValidateComponentsRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/ValidateComponentsResponse'}}}
  /rpc/GetLogMessages:
    post:
      summary: Get logged messages
      description: Get info, errors and warnings logged during processing
      tags: [/rpc]
      requestBody:
        content: {application/json: {schema: {$ref: '#/components/schemas/GetLogMessagesRequest'}}}
      responses:
        '200':
          description: OK
          content: {application/json: {schema: {$ref: '#/components/schemas/GetLogMessagesResponse'}}}

components:
  schemas:
    SuccessResult:
      type: object
      properties:
        success:
          type: boolean
          description: true if requested operation has been performed successfully or selection has been modified
        message:
          type: string
          description: optional error/warning/info message
      required:
        - success
    Common:
      type: object
      properties:
        id:
          type: string
          description: Identifier
        description:
          type: string
          description: Description
        doc:
          type: string
          description: Documentation
      required:
        - id
    Pack:
      allOf:
        - $ref: '#/components/schemas/Common'
        - properties:
            overview:
              type: string
              description: Pack overview
            used:
              type: boolean
              description: True when pack is used in the current context
            references:
              type: array
              description: List of yml files where the pack is referenced
              items:
                type: string
    PacksInfo:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            packs:
              type: array
              description: List of packs information
              items:
                $ref: '#/components/schemas/Pack'
          required:
            - packs
    Component:
      allOf:
        - $ref: '#/components/schemas/Common'
        - properties:
            pack:
              type: string
              description: Pack that defines this component
            implements:
              type: string
              description: Refers to the API that the component is based on
            maxInstances:
              type: integer
              description: Maximum of supported component instances
          required:
            - pack
    Options:
      type: object
      properties:
        layer:
          type: string
          description: Absolute path to .clayer.yml file
        explicitVersion:
          type: string
          description: 'Version requirement in SemVer syntax: https://open-cmsis-pack.github.io/cmsis-toolbox/YML-Input-Format/#name-conventions empty '
        explicitVendor:
          type: boolean
          description: Flag to prefix component ID with vendor when adding component to project or layer, false
    ComponentInstance:
      type: object
      properties:
        id:
          type: string
          description: Identifier
        selectedCount:
          type: integer
          description: Number of selected instances
        generator:
          type: string
          description: Associated generator name
        fixed:
          type: boolean
          description: Component cannot be unselected
        options:
          $ref: '#/components/schemas/Options'
        resolvedComponent:
          $ref: '#/components/schemas/Component'
      required:
        - id
        - selectedCount
    CtItem:
      type: object
      properties:
        name:
          type: string
          description: Name of element
        result:
          type: string
          description: 'Condition result: https://github.com/Open-CMSIS-Pack/devtools/blob/tools/projmgr/2.8.0/libs/rtemodel/include/RteItem.h#L78-L95'
      required:
        - name
    CtVariant:
      allOf:
        - $ref: '#/components/schemas/CtItem'
        - type: object
          properties:
            components:
              type: array
              description: Version-sorted components
              items:
                $ref: '#/components/schemas/Component'
          required:
            - components
    CtAggregate:
      allOf:
        - $ref: '#/components/schemas/CtItem'
        - type: object
          properties:
            id:
              type: string
              description: Identifier
            activeVariant:
              type: string
              description: Variant
            activeVersion:
              type: string
              description: Version
            selectedCount:
              type: integer
              description: Number of selected instances
            generator:
              type: string
              description: Associated generator name
            fixed:
              type: boolean
              description: Component cannot be unselected
            variants:
              type: array
              items:
                $ref: '#/components/schemas/CtVariant'
            options:
              $ref: '#/components/schemas/Options'
          required:
            - id
            - variants
    CtTreeItem:
      allOf:
        - $ref: '#/components/schemas/CtItem'
        - type: object
          properties:
            cgroups:
              type: array
              items:
                $ref: '#/components/schemas/CtGroup'
            aggregates:
              type: array
              items:
                $ref: '#/components/schemas/CtAggregate'
    Api:
      description: Api
      allOf:
        - $ref: '#/components/schemas/Common'
    Taxonomy:
      description: Taxonomy
      allOf:
        - $ref: '#/components/schemas/Common'
    CtGroup:
      allOf:
        - $ref: '#/components/schemas/CtTreeItem'
        - type: object
          properties:
            api:
              $ref: '#/components/schemas/Api'
            taxonomy:
              $ref: '#/components/schemas/Taxonomy'
    Bundle:
      description: Bundle
      allOf:
        - $ref: '#/components/schemas/Common'
    CtBundle:
      allOf:
        - $ref: '#/components/schemas/CtTreeItem'
        - type: object
          properties:
            bundle:
              $ref: '#/components/schemas/Bundle'
    CtClass:
      allOf:
        - $ref: '#/components/schemas/CtItem'
        - type: object
          properties:
            taxonomy:
              $ref: '#/components/schemas/Taxonomy'
            activeBundle:
              type: string
            bundles:
              type: array
              items:
                $ref: '#/components/schemas/CtBundle'
          required:
            - bundles
    CtRoot:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            classes:
              type: array
              description: Array of Component Classes
              items:
                $ref: '#/components/schemas/CtClass'
          required:
            - classes
    Condition:
      type: object
      properties:
        expression:
          type: string
          description: Condition expression (accept, require, deny ...)
        aggregates:
          type: array
          description: List of aggregates related to this condition
          items:
            type: string
      required:
        - expression
    Result:
      type: object
      properties:
        result:
          type: string
          description: 'Condition result: https://github.com/Open-CMSIS-Pack/devtools/blob/tools/projmgr/2.8.0/libs/rtemodel/include/RteItem.h#L78-L95'
        id:
          type: string
          description: Component or API identifier
        aggregates:
          type: array
          description: List of aggregates related to this result
          items:
            type: string
        conditions:
          type: array
          description: List of conditions related to this result
          items:
            $ref: '#/components/schemas/Condition'
      required:
        - id
        - result
    Results:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            result:
              type: string
              description: 'Condition result: https://github.com/Open-CMSIS-Pack/devtools/blob/tools/projmgr/2.8.0/libs/rtemodel/include/RteItem.h#L78-L95'
            validation:
              type: array
              items:
                $ref: '#/components/schemas/Result'
          required:
            - result
    UsedItems:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            components:
              type: array
              items:
                $ref: '#/components/schemas/ComponentInstance'
            packs:
              type: array
              items:
                $ref: '#/components/schemas/Pack'
          required:
            - components
            - packs

    LogMessages:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            info:
              type: array
              items:
                type: string
            errors:
              type: array
              items:
                type: string
            warnings:
              type: array
              items:
                type: string

    GetVersionRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request'
        - properties:
            method:
              type: string
              const: GetVersion

    GetVersionResult:
      allOf:
        - $ref: '#/components/schemas/SuccessResult'
        - properties:
            version:
              type: string
              description: Tool version
    GetVersionResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/GetVersionResult'
    ShutdownRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request'
        - properties:
            method:
              type: string
              const: Shutdown
    ShutdownResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    ApplyRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: Apply
            params:
              type: object
              properties:
                context:
                  type: string
              required:
                - context
    ApplyResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    ResolveRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: Resolve
            params:
              type: object
              properties:
                context:
                  type: string
              required:
                - context
    ResolveResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    LoadPacksRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request'
        - properties:
            method:
              type: string
              const: LoadPacks
    LoadPacksResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    LoadSolutionRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: LoadSolution
            params:
              type: object
              properties:
                solution:
                  type: string
              required:
                - solution
    LoadSolutionResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    GetPacksInfoRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: GetPacksInfo
            params:
              type: object
              properties:
                context:
                  type: string
              required:
                - context
    GetPacksInfoResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/PacksInfo'
    GetUsedItemsRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: GetUsedItems
            params:
              type: object
              properties:
                context:
                  type: string
              required:
                - context
    GetUsedItemsResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/UsedItems'
    GetComponentsTreeRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: GetComponentsTree
            params:
              type: object
              properties:
                context:
                  type: string
                all:
                  type: boolean
              required:
                - context
                - all
    GetComponentsTreeResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/CtRoot'
    SelectComponentRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: SelectComponent
            params:
              type: object
              properties:
                context:
                  type: string
                id:
                  type: string
                  description: component aggregate ID
                count:
                  type: integer
                  description: number of instances to select, 0 to select unselect
                options:
                  $ref: '#/components/schemas/Options'
              required:
                - context
                - id
                - count
                - options
    SelectComponentResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    SelectVariantRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: SelectVariant
            params:
              type: object
              properties:
                context:
                  type: string
                id:
                  type: string
                  description: component aggregate ID
                variant:
                  type: string
              required:
                - context
                - id
                - variant
    SelectVariantResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
               $ref: '#/components/schemas/SuccessResult'
    SelectBundleRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: SelectBundle
            params:
              type: object
              properties:
                context:
                  type: string
                cclass:
                  type: string
                bundle:
                  type: string
              required:
                - context
                - cclass
                - bundle
    SelectBundleResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/SuccessResult'
    ValidateComponentsRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request-with-params'
        - properties:
            method:
              type: string
              const: ValidateComponents
            params:
              type: object
              properties:
                context:
                  type: string
              required:
                - context
    ValidateComponentsResponse:
       allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/Results'
    GetLogMessagesRequest:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-request'
        - properties:
            method:
              type: string
              const: GetLogMessages
    GetLogMessagesResponse:
      allOf:
        - $ref: '#/x-jsonrpc-envelope-response'
        - properties:
            result:
              $ref: '#/components/schemas/LogMessages'

x-jsonrpc-envelope-request:
  allOf:
    - $ref: '#/x-jsonrpc-envelope'
    - required:
        - method

x-jsonrpc-envelope-request-with-params:
  allOf:
    - $ref: '#/x-jsonrpc-envelope-request'
    - required:
        - params

x-jsonrpc-envelope-response:
  allOf:
    - $ref: '#/x-jsonrpc-envelope'
    - required:
        - result

x-jsonrpc-envelope:
  type: object
  properties:
    jsonrpc:
      type: string
      const: '2.0'
    id:
      type: number
  required:
    - jsonrpc
    - id
